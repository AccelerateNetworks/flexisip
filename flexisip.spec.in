# -*- rpm-spec -*-

## rpmbuild options

# default is to build with redis & protobuf support
%define     redis       %{?_without_redis:0}%{!?_without_redis:1}
%define     protobuf       %{?_without_protobuf:0}%{!?_without_protobuf:1}
%define     boostlog       %{?_without_boostlog:0}%{!?_without_boostlog:1}
%define     push       %{?_with_push:1}%{!?_without_push:0}
%define     odbc       %{?_without_odbc:0}%{!?_without_odbc:1}
%define     transcoder      %{?_without_transcoder:0}%{!?_without_transcoder:1}
%define     snmp      %{?_without_snmp:0}%{!?_without_snmp:1}

# will be 1 if we need to generate a /opt/belledonne-communications RPM
%define     bcpkg       %{?_with_bc:1}%{!?_with_bc:0}

# These lines are here because we can build the RPM for flexisip, in which 
# case we prefix the entire installation so that we don't break compatibility
# with the user's libs.
# To compile with bc prefix, use rpmbuild -ba --with bc [SPEC]
%define                 pkg_name        %{?_with_bc:bc-flexisip}%{!?_with_bc:flexisip}
%define                 pkg_prefix      %{?_with_bc:bc-}%{!?_with_bc:}
%{?_with_bc: %define    _prefix         /opt/belledonne-communications}

# 
# flexisip - SIP proxy with media capabilities
# 

Summary:	SIP proxy with media capabilities
Name:		%pkg_name
Version:	@PACKAGE_VERSION@
Release:	%(git describe --tags --abbrev=40 | sed -rn 's/^.*-([0-9]+)-g[a-z0-9]{40}$/\1/p' || echo '1')%{?dist}
License:	AGPL
Group:		Applications/Communications
URL:		http://www.belledonne-communications.com
Source0:	flexisip-@PACKAGE_VERSION@.tar.gz
BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-buildroot
%ifarch %ix86
BuildArch:	i686
%endif
Requires: bash >= 2.0
%if %{odbc}
Requires: %{pkg_prefix}unixODBC >= 2.3.0
%endif
%if %{boostlog}
Requires: boost-log >= 1.41.0
%endif
Requires(post): /sbin/chkconfig coreutils
Requires(preun): /sbin/chkconfig /sbin/chkconfig
Requires(postun): /sbin/service

%description
Extensible SIP proxy with media capabilities. Designed for robustness and easy of use.

%prep
%setup -qn flexisip-%{version}

%build
%configure \
	--disable-strict \
%if %{redis}
    --enable-redis \
%endif
%if %{protobuf}
    --enable-protobuf \
%endif
%if !%{odbc}
    --disable-odbc \
%endif
%if !%{snmp}
    --disable-snmp \
%endif
%if !%{boostlog}
    --disable-boostlog \
%endif
%if !%{transcoder}
    --disable-transcoder \
%endif
%if !%{push}
    --disable-pushnotification \
%endif
%if %{bcpkg}
    --with-odbc=%{_prefix} \
%endif
	--sysconfdir=%{_sysconfdir} 

%{__make} 

# parallel build disabled due to automake libtool random errors
#%{__make} -j$RPM_BUILD_NCPUS 

%install
rm -rf $RPM_BUILD_ROOT
%makeinstall
rm -rf /usr/share/doc/%{name}-@PACKAGE_VERSION@/*.tmp.tex
install -p -m 0744 scripts/redhat/flexisip $RPM_BUILD_ROOT%{_sysconfdir}/init.d/flexisip

%if %{bcpkg}
export QA_RPATHS=0x0003
%endif

%clean
rm -rf $RPM_BUILD_ROOT

%post
if [ $1 = 1 ]; then
	/sbin/chkconfig --add flexisip
	/sbin/chkconfig flexisip on
	service flexisip start
fi

%preun
if [ $1 = 0 ]; then
	service flexisip stop >/dev/null 2>&1 ||:
	/sbin/chkconfig --del flexisip
fi

%postun
if [ "$1" -ge "1" ]; then
	service flexisip condrestart > /dev/null 2>&1 ||:
fi	

%files
%defattr(-,root,root,-)
%doc AUTHORS COPYING ChangeLog INSTALL NEWS README
%if !%{bcpkg}
%doc %{_prefix}/share/doc/flexisip/flexisip_guide.tex 
%doc %{_prefix}/share/doc/*.pdf 
%doc %{_prefix}/share/doc/latex_include_generator.sh
%endif

%exclude %{_prefix}/share/doc/flexisip
%{_bindir}/*
/etc/init.d/flexisip
/etc/flexisip

%changelog
* Tue Oct 14 2014 Guillaume Bienkowski <gbi@linphone.org>
	- Add /opt packaging possibility
* Wed Feb 15 2012 Guillaume Beraudo <guillaume.beraudo@belledonne-communications.com>
    - Force use of redhat init script
* Tue Oct 19 2010 Simon Morlat <simon.morlat@belledonne-communications.com>
	- Initial specfile for first prototype release
