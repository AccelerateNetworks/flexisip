#!/bin/bash

FLEXISIP=flexisip
SIPP=sipp
NB_USERS=10000
IP=127.0.0.1
PROXY=sip.example.org
USERS_PORT=5063
INVITER_PORT=5064
SIPP_COMMONS=" -trace_err"

# Import configuration
. launch.config

echo "Using FLEXISIP=$FLEXISIP,SIPP$SIPP,NB_USERS=$NB_USERS"
echo "IP=$IP,PROXY=$PROXY"
echo "Sofia SIP log level: $SU_DEBUG, LD_LIBRARY_PATH=$LD_LIBRARY_PATH"

# Accept core dumps
ulimit -c unlimited


# clean logs
rm -f *.log

echo ""; echo "Start users listening"
$SIPP -sf uas.xml -i $IP -p $USERS_PORT $SIPP_COMMONS 2>&1 > /dev/null &

echo "Start flexisip"
$FLEXISIP --debug  2>&1 > flexisip.log &
sleep 5s

echo ""; echo "Register users"
$SIPP $PROXY -sf register_users.xml -m $NB_USERS -i $IP -p 5070 $REG_OPTIONS $SIPP_COMMONS



# Allow killing
function onexit() {
 echo "Killing everyone"
 killall flexisip 2>/dev/null
 killall sipp 2>/dev/null
 exit
}
set -o errtrace 
trap onexit 1 2 3 15 ERR

echo "" ; echo "Start inviting users"
while [ true ]
do
  $SIPP $PROXY -sf simple_invites.xml -m $NB_USERS -i $IP -p $INVITER_PORT $INV_OPTIONS $SIPP_COMMONS
done

onexit 
