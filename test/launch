#!/bin/bash

FLEXISIP=flexisip
SIPP=sipp
NB_USERS=10000
IP=$(/usr/sbin/arp $(hostname) | nawk -F'[()]' '{print $2}')
PROXY=sip.example.org
USERS_PORT=5063
INVITER_PORT=5064

# Import configuration
. launch.config

echo "Using FLEXISIP=$FLEXISIP,SIPP$SIPP,NB_USERS=$NB_USERS"
echo "IP=$IP,PROXY=$PROXY"


# Allow killing
function onexit() {
 echo "Killing everyone"
 killall flexisip
 killall sipp
 exit
}
set -o errtrace 
trap onexit 1 2 3 15 ERR

mkdir -p log

echo "Start flexisip"
$FLEXISIP --debug  2>&1 > log/1-flexisip.log &
sleep 5s

echo ""; echo "Register users"
$SIPP $PROXY -sf register_users.xml -m $NB_USERS -i $IP -p $USERS_PORT -trace_err 2>&1 > log/2-spp_register_users.log

echo ""; echo "Start users listening"
$SIPP -sf uas.xml -m $NB_USERS -i $IP -p $USERS_PORT -trace_err 2>&1 > log/3-spp_uas.log &

echo "" ; echo "Start inviting users"
echo "" >  log/4-spp_simple_invites.log
#while [ true ]
#do
  $SIPP $PROXY -sf simple_invites.xml -m $NB_USERS -i $IP -p $INVITER_PORT -trace_err 2>&1 >> log/4-spp_simple_invites.log
#done

onexit
